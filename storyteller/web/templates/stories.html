{% extends "base.html" %}

{% block title %}Story Library - Bedtime Storyteller{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Story Library</h1>
                <p class="lead">Manage your collection of bedtime stories</p>
            </div>
            <button class="btn btn-primary" onclick="showNewStoryModal()">
                <i class="bi bi-plus-circle"></i> New Story
            </button>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" placeholder="Search stories..." id="searchInput">
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="languageFilter">
            <option value="">All Languages</option>
            <option value="tr">Turkish</option>
            <option value="en">English</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="completed">Completed</option>
            <option value="active">Active</option>
            <option value="failed">Failed</option>
        </select>
    </div>
</div>

<!-- Story Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-collection display-4 text-primary mb-2"></i>
                <h4 class="text-primary" id="totalStories">0</h4>
                <small class="text-muted">Total Stories</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-check-circle display-4 text-success mb-2"></i>
                <h4 class="text-success" id="completedStories">0</h4>
                <small class="text-muted">Completed</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-clock display-4 text-info mb-2"></i>
                <h4 class="text-info" id="averageDuration">0s</h4>
                <small class="text-muted">Avg Duration</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-star display-4 text-warning mb-2"></i>
                <h4 class="text-warning" id="favoriteStories">0</h4>
                <small class="text-muted">Favorites</small>
            </div>
        </div>
    </div>
</div>

<!-- Story List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list"></i> Stories
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Created</th>
                                <th>Prompt</th>
                                <th>Language</th>
                                <th>Age</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Paragraphs</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="storiesTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">Loading stories...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Story pagination">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Story Details Modal -->
<div class="modal fade" id="storyDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Story Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="storyDetailsContent">
                <!-- Story details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="deleteCurrentStory()">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    const pageSize = 10;
    let currentStoryId = null;
    let allStories = [];
    let filteredStories = [];
    
    function loadStories(page = 1) {
        const offset = (page - 1) * pageSize;
        
        fetch(`/api/stories?limit=${pageSize}&offset=${offset}`)
            .then(response => response.json())
            .then(data => {
                allStories = data;
                filteredStories = data;
                updateStoriesTable();
                updateStats();
            })
            .catch(error => {
                console.error('Stories load failed:', error);
                showError('Failed to load stories');
            });
    }
    
    function updateStoriesTable() {
        const tbody = document.getElementById('storiesTableBody');
        
        if (filteredStories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No stories found</td></tr>';
            return;
        }
        
        tbody.innerHTML = filteredStories.map(story => `
            <tr class="story-row" data-story-id="${story.session_id}">
                <td>${new Date(story.created_at).toLocaleString()}</td>
                <td>
                    <div class="story-prompt" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                        ${story.prompt}
                    </div>
                </td>
                <td><span class="badge bg-info">${story.language}</span></td>
                <td><span class="badge bg-secondary">${story.age_rating}</span></td>
                <td><span class="badge ${getStatusClass(story.status)}">${story.status}</span></td>
                <td>${calculateDuration(story.created_at, story.completed_at)}</td>
                <td>${story.paragraphs_generated}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewStory('${story.session_id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteStory('${story.session_id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        // Add click handlers to story rows
        document.querySelectorAll('.story-row').forEach(row => {
            row.addEventListener('click', (e) => {
                if (!e.target.closest('.btn-group')) {
                    const storyId = row.dataset.storyId;
                    viewStory(storyId);
                }
            });
        });
    }
    
    function updateStats() {
        const total = allStories.length;
        const completed = allStories.filter(s => s.status === 'completed').length;
        const totalDuration = allStories.reduce((sum, s) => {
            if (s.completed_at) {
                return sum + (new Date(s.completed_at) - new Date(s.created_at));
            }
            return sum;
        }, 0);
        const avgDuration = completed > 0 ? Math.floor(totalDuration / completed / 1000) : 0;
        
        document.getElementById('totalStories').textContent = total;
        document.getElementById('completedStories').textContent = completed;
        document.getElementById('averageDuration').textContent = `${avgDuration}s`;
        document.getElementById('favoriteStories').textContent = '0'; // TODO: Implement favorites
    }
    
    function viewStory(storyId) {
        currentStoryId = storyId;
        
        fetch(`/api/stories/${storyId}`)
            .then(response => response.json())
            .then(story => {
                const modalContent = document.getElementById('storyDetailsContent');
                modalContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Session Information</h6>
                            <p><strong>ID:</strong> ${story.session_id}</p>
                            <p><strong>Created:</strong> ${new Date(story.created_at).toLocaleString()}</p>
                            <p><strong>Completed:</strong> ${story.completed_at ? new Date(story.completed_at).toLocaleString() : 'Not completed'}</p>
                            <p><strong>Status:</strong> <span class="badge ${getStatusClass(story.status)}">${story.status}</span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>Story Details</h6>
                            <p><strong>Language:</strong> ${story.language}</p>
                            <p><strong>Age Rating:</strong> ${story.age_rating}</p>
                            <p><strong>Paragraphs:</strong> ${story.paragraphs_generated}</p>
                            <p><strong>Duration:</strong> ${calculateDuration(story.created_at, story.completed_at)}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Story Prompt</h6>
                            <div class="card">
                                <div class="card-body">
                                    <p class="card-text">${story.prompt}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('storyDetailsModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Story details load failed:', error);
                showError('Failed to load story details');
            });
    }
    
    function deleteStory(storyId) {
        if (!confirm('Are you sure you want to delete this story?')) {
            return;
        }
        
        fetch(`/api/stories/${storyId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                showNotification('Story deleted successfully', 'success');
                loadStories(currentPage);
            })
            .catch(error => {
                console.error('Story deletion failed:', error);
                showError('Failed to delete story');
            });
    }
    
    function deleteCurrentStory() {
        if (currentStoryId) {
            deleteStory(currentStoryId);
            const modal = bootstrap.Modal.getInstance(document.getElementById('storyDetailsModal'));
            modal.hide();
        }
    }
    
    function filterStories() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const languageFilter = document.getElementById('languageFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        
        filteredStories = allStories.filter(story => {
            const matchesSearch = story.prompt.toLowerCase().includes(searchTerm);
            const matchesLanguage = !languageFilter || story.language === languageFilter;
            const matchesStatus = !statusFilter || story.status === statusFilter;
            
            return matchesSearch && matchesLanguage && matchesStatus;
        });
        
        updateStoriesTable();
    }
    
    function getStatusClass(status) {
        switch (status) {
            case 'completed': return 'bg-success';
            case 'active': return 'bg-primary';
            case 'failed': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    function calculateDuration(start, end) {
        if (!end) return 'Active';
        const duration = Math.floor((new Date(end) - new Date(start)) / 1000);
        return `${duration}s`;
    }
    
    function showError(message) {
        showNotification(message, 'danger');
    }
    
    // Event listeners
    document.getElementById('searchInput').addEventListener('input', filterStories);
    document.getElementById('languageFilter').addEventListener('change', filterStories);
    document.getElementById('statusFilter').addEventListener('change', filterStories);
    
    // Load stories on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadStories();
    });
</script>
{% endblock %}